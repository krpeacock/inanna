name: Deploy to Internet Computer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DFX_VERSION: 0.15.3

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Zola
        run: |
          sudo snap install --edge zola

      - name: Build site
        run: zola build

      - name: Install dfx
        uses: dfinity/setup-dfx@main
        with:
          dfx-version: "${{ env.DFX_VERSION }}"

      - name: Configure dfx identity
        env:
          IC_DEPLOY_KEY: ${{ secrets.IC_DEPLOY_KEY }}
        run: |
          mkdir -p ./tmp/identity/default
          echo "$IC_DEPLOY_KEY" > ./tmp/identity/default/identity.pem
          dfx identity import ./tmp/identity/default/identity.pem

      - name: Initialize dfx
        run: |
          dfx identity use default

      - name: Deploy to IC
        run: |
          dfx deploy --network ic 
